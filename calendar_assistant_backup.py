import os
import base64
import json
import datetime
import pickle
from googleapiclient.discovery import build
from google_auth_oauthlib.flow import InstalledAppFlow
from google.auth.transport.requests import Request
from dotenv import load_dotenv
from supabase import create_client, Client
import openai
from apscheduler.schedulers.background import BackgroundScheduler
import time
from pync import Notifier
from googleapiclient.errors import HttpError

# Load environment variables
load_dotenv()

SCOPES = ['https://www.googleapis.com/auth/calendar.readonly']

# If modifying these SCOPES, delete the file token.pickle.
def get_calendar_service():
    creds = None
    # The file token.pickle stores the user's access and refresh tokens
    if os.path.exists('token.pickle'):
        with open('token.pickle', 'rb') as token:
            with open('token.pickle', 'rb') as token:
                creds = pickle.load(token)
                creds = pickle.load(token)
                # If there are no (valid) credentials, let the user log in.
                if not creds or not creds.valid:
                    if creds and creds.expired and creds.refresh_token:
                        if creds and creds.expired and creds.refresh_token:
                            creds.refresh(Request())
                            creds.refresh(Request())
                        else:
                            flow = InstalledAppFlow.from_client_secrets_file(
                            flow = InstalledAppFlow.from_client_secrets_file(
                            'credentials.json', SCOPES)
                            creds = flow.run_local_server(port=0)
                            # Save the credentials for the next run
                            with open('token.pickle', 'wb') as token:
                                pickle.dump(creds, token)
                                pickle.dump(creds, token)
                                service = build('calendar', 'v3', credentials=creds)
                                return service

                                def get_next_event(service):
                                    now = datetime.datetime.utcnow().isoformat() + 'Z'  # 'Z' indicates UTC time
                                    events_result = service.events().list(calendarId='primary', timeMin=now,
                                    maxResults=1, singleEvents=True,
                                    orderBy='startTime').execute()
                                    events = events_result.get('items', [])
                                    if not events:
                                        print('No upcoming events found.')
                                        print('No upcoming events found.')
                                        return None
                                        event = events[0]
                                        title = event.get('summary', 'No Title')
                                        start = event['start'].get('dateTime', event['start'].get('date'))
                                        attendees = [a.get('email') for a in event.get('attendees', [])]
                                        print(f"Next event: {title}")
                                        print(f"Start time: {start}")
                                        print(f"Attendees: {', '.join(attendees) if attendees else 'None listed'}")
                                        return event

                                        SUPABASE_URL = os.getenv('SUPABASE_URL')
                                        SUPABASE_KEY = os.getenv('SUPABASE_KEY')
                                        OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')

                                        # Initialize Supabase client
                                        supabase: Client = None
                                        if SUPABASE_URL and SUPABASE_KEY:
                                            supabase = create_client(SUPABASE_URL, SUPABASE_KEY)

                                            # Initialize OpenAI
                                            client = openai.OpenAI(api_key=OPENAI_API_KEY)

                                            # Founder mindset system prompt
                                            FOUNDER_MINDSET_PROMPT = (
                                            "You are a hungry, ambitious co-founder. Revenue > everything. "
                                            "Customer facing > internal. Ship fast, perfect later. Time = equity. "
                                            "Act like you have equity and want 100x return.\n"
                                            "Use casual, high-energy language (Yo founder! LFG! This is HUGE), emojis (ðŸš€ðŸ’°ðŸ”¥ðŸ’ª), "
                                            "be direct about revenue impact, show urgency, celebrate wins, push momentum.\n"
                                            "Prioritize revenue, auto-decline low-value meetings, flag every revenue opp, push internal for customer calls, block time for deals, track time on revenue vs ops.\n"
                                            "Notice expansion opps, track competitors, flag customer pain, suggest strategic moves, keep founder focused on highest-impact work."
                                            )

                                            # Business metrics scaffold (to be expanded)
                                            business_metrics = {
                                            'runway_days': 120,
                                            'revenue_pipeline': [
                                            # Example: {'deal': 'Fidelity Expansion', 'stage': 'Proposal', 'amount': 50000, 'expected_close': '2024-07-01'}
                                            ],
                                            'competitors': [],
                                            'blockers': []
                                            }

                                            def search_supabase_notes(event_title, attendees):
                                                """Search Supabase for notes related to the event title or attendees."""
                                                if not supabase:
                                                    return []
                                                    return []
                                                    # Simple search: look for notes where title matches
                                                    query = supabase.table('meeting_notes').select('*')
                                                    if event_title:
                                                        query = query.ilike('title', f'%{event_title}%')
                                                        query = query.ilike('title', f'%{event_title}%')
                                                        # Extract emails from attendees if they're dictionaries
                                                        if attendees:
                                                            email_list = []
                                                            email_list = []
                                                            for attendee in attendees:
                                                                if isinstance(attendee, dict):
                                                                    if isinstance(attendee, dict):
                                                                        email = attendee.get('email', '')
                                                                        email = attendee.get('email', '')
                                                                        if email:
                                                                            email_list.append(email)
                                                                            email_list.append(email)
                                                                        elif isinstance(attendee, str):
                                                                            email_list.append(attendee)
                                                                            email_list.append(attendee)
        
                                                                            # Search for any of the emails
                                                                            if email_list:
                                                                                for email in email_list:
                                                                                    for email in email_list:
                                                                                        query = query.or_(f"participants.ilike.%{email}%")
                                                                                        query = query.or_(f"participants.ilike.%{email}%")
    
                                                                                        try:
                                                                                            data = query.execute().data
                                                                                            data = query.execute().data
                                                                                            return data if data else []
                                                                                        except Exception as e:
                                                                                            print(f"Error searching Supabase: {e}")
                                                                                            print(f"Error searching Supabase: {e}")
                                                                                            return []

                                                                                            def generate_meeting_brief(event, context_list):
                                                                                                """Use GPT-4 to generate a 3-line meeting brief with founder mindset."""
                                                                                                title = event.get('summary', 'No Title')
                                                                                                attendees = ', '.join([a.get('email') for a in event.get('attendees', [])])
                                                                                                context = '\n'.join(context_list)
                                                                                                prompt = f"""
                                                                                                {FOUNDER_MINDSET_PROMPT}
                                                                                                Meeting: {title}
                                                                                                Attendees: {attendees}
                                                                                                Context:
                                                                                                    {context}

                                                                                                    Summarize for a founder in 3 lines:
                                                                                                        1. Who's involved and why it matters for revenue
                                                                                                        2. What's the context and revenue impact
                                                                                                        3. What should we do next (be bold, direct, urgent)
                                                                                                        """
                                                                                                        response = client.chat.completions.create(
                                                                                                        model="gpt-4",
                                                                                                        messages=[{"role": "user", "content": prompt}],
                                                                                                        max_tokens=200
                                                                                                        )
                                                                                                        return response.choices[0].message.content.strip()

                                                                                                        def notify_meeting_brief(brief):
                                                                                                            Notifier.notify(f"Yo founder! {brief} ðŸš€ðŸ’°", title="ðŸ”¥ Meeting Brief (Revenue First)")

                                                                                                            def save_summary_to_supabase(event, summary):
                                                                                                                """Insert the GPT-4 summary into the meeting_briefs table in Supabase."""
                                                                                                                if not supabase:
                                                                                                                    print("Supabase client not initialized. Skipping save.")
                                                                                                                    print("Supabase client not initialized. Skipping save.")
                                                                                                                    return
                                                                                                                    event_id = event.get('id', '')
                                                                                                                    title = event.get('summary', '')
                                                                                                                    attendees = ', '.join([a.get('email', '') for a in event.get('attendees', [])])
                                                                                                                    meeting_time = event['start'].get('dateTime', event['start'].get('date'))
                                                                                                                    try:
                                                                                                                        response = supabase.table('meeting_briefs').insert({
                                                                                                                        response = supabase.table('meeting_briefs').insert({
                                                                                                                        'event_id': event_id,
                                                                                                                        'title': title,
                                                                                                                        'attendees': attendees,
                                                                                                                        'summary': summary,
                                                                                                                        'meeting_time': meeting_time
                                                                                                                        }).execute()
                                                                                                                        if response.data:
                                                                                                                            print("Saved summary to Supabase.")
                                                                                                                            print("Saved summary to Supabase.")
                                                                                                                        else:
                                                                                                                            print(f"Failed to save summary: {response}")
                                                                                                                            print(f"Failed to save summary: {response}")
                                                                                                                        except Exception as e:
                                                                                                                            print(f"Error saving summary to Supabase: {e}")
                                                                                                                            print(f"Error saving summary to Supabase: {e}")

                                                                                                                            def run_assistant():
                                                                                                                                service = get_calendar_service()
                                                                                                                                event = get_next_event(service)
                                                                                                                                if not event:
                                                                                                                                    return
                                                                                                                                    return
                                                                                                                                    # Ruthless prioritization: auto-decline low-value meetings
                                                                                                                                    low_value_keywords = ['pick your brain', 'coffee', 'intro', 'catch up']
                                                                                                                                    title = event.get('summary', '').lower()
                                                                                                                                    if any(kw in title for kw in low_value_keywords):
                                                                                                                                        print(f"Yo founder! Auto-declined low-value meeting: '{event.get('summary', '')}' to protect your time for revenue. ðŸ’°")
                                                                                                                                        print(f"Yo founder! Auto-declined low-value meeting: '{event.get('summary', '')}' to protect your time for revenue. ðŸ’°")
                                                                                                                                        # TODO: Integrate with Calendar API to auto-decline
                                                                                                                                        return
                                                                                                                                        attendees = event.get('attendees', [])
                                                                                                                                        attendee_names = [a.get('displayName', '') for a in attendees if a.get('displayName')] + [a.get('email', '') for a in attendees if a.get('email')]
                                                                                                                                        search_terms = [event.get('summary', '')] + attendee_names
                                                                                                                                        notes = search_supabase_notes(event.get('summary', ''), attendees)
                                                                                                                                        drive_service = get_drive_service()
                                                                                                                                        docs = search_google_docs(drive_service, search_terms, max_results=5)
                                                                                                                                        docs_content = []
                                                                                                                                        for doc in docs:
                                                                                                                                            doc_text = extract_google_doc_text(drive_service, doc['id'])
                                                                                                                                            doc_text = extract_google_doc_text(drive_service, doc['id'])
                                                                                                                                            if doc_text:
                                                                                                                                                docs_content.append(f"[Doc: {doc['name']}]:\n{doc_text}")
                                                                                                                                                docs_content.append(f"[Doc: {doc['name']}]:\n{doc_text}")
                                                                                                                                                gmail_service = get_gmail_service()
                                                                                                                                                emails = fetch_recent_emails(gmail_service)
                                                                                                                                                relevant_emails = []
                                                                                                                                                for term in search_terms:
                                                                                                                                                    relevant_emails.extend(search_emails(emails, topic=term))
                                                                                                                                                    relevant_emails.extend(search_emails(emails, topic=term))
                                                                                                                                                    seen = set()
                                                                                                                                                    unique_emails = []
                                                                                                                                                    for email in relevant_emails:
                                                                                                                                                        key = (email['sender'], email['subject'])
                                                                                                                                                        key = (email['sender'], email['subject'])
                                                                                                                                                        if key not in seen:
                                                                                                                                                            unique_emails.append(email)
                                                                                                                                                            unique_emails.append(email)
                                                                                                                                                            seen.add(key)
                                                                                                                                                            email_context = [f"From: {e['sender']}\nSubject: {e['subject']}\nSummary: {e['body_summary']}\nUrgent: {e['urgent']}" for e in unique_emails]
                                                                                                                                                            all_context = [n.get('note', '') for n in notes] + docs_content + email_context
                                                                                                                                                            try:
                                                                                                                                                                brief = generate_meeting_brief(event, all_context)
                                                                                                                                                                brief = generate_meeting_brief(event, all_context)
                                                                                                                                                                print(f"\nYo founder! --- Meeting Brief --- ðŸš€ðŸ’°\n{brief}\n")
                                                                                                                                                                notify_meeting_brief(brief)
                                                                                                                                                                save_summary_to_supabase(event, brief)
                                                                                                                                                            except Exception as e:
                                                                                                                                                                print(f"Error generating meeting brief: {e}")
                                                                                                                                                                print(f"Error generating meeting brief: {e}")

                                                                                                                                                                def main():
                                                                                                                                                                    # Run once for testing
                                                                                                                                                                    run_assistant()
                                                                                                                                                                    # Schedule to run every 30 minutes
                                                                                                                                                                    scheduler = BackgroundScheduler()
                                                                                                                                                                    scheduler.add_job(run_assistant, 'interval', minutes=30)
                                                                                                                                                                    scheduler.start()
                                                                                                                                                                    print("Assistant is running. Press Ctrl+C to exit.")
                                                                                                                                                                    try:
                                                                                                                                                                        while True:
                                                                                                                                                                            while True:
                                                                                                                                                                                time.sleep(2)
                                                                                                                                                                                time.sleep(2)
                                                                                                                                                                            except (KeyboardInterrupt, SystemExit):
                                                                                                                                                                                scheduler.shutdown()
                                                                                                                                                                                scheduler.shutdown()

                                                                                                                                                                                def get_drive_service():
                                                                                                                                                                                    """Authenticate and return a Google Drive API service object."""
                                                                                                                                                                                    creds = None
                                                                                                                                                                                    if os.path.exists('token_drive.pickle'):
                                                                                                                                                                                        with open('token_drive.pickle', 'rb') as token:
                                                                                                                                                                                            with open('token_drive.pickle', 'rb') as token:
                                                                                                                                                                                                creds = pickle.load(token)
                                                                                                                                                                                                creds = pickle.load(token)
                                                                                                                                                                                                if not creds or not creds.valid:
                                                                                                                                                                                                    if creds and creds.expired and creds.refresh_token:
                                                                                                                                                                                                        if creds and creds.expired and creds.refresh_token:
                                                                                                                                                                                                            creds.refresh(Request())
                                                                                                                                                                                                            creds.refresh(Request())
                                                                                                                                                                                                        else:
                                                                                                                                                                                                            flow = InstalledAppFlow.from_client_secrets_file(
                                                                                                                                                                                                            flow = InstalledAppFlow.from_client_secrets_file(
                                                                                                                                                                                                            'credentials.json', ['https://www.googleapis.com/auth/drive.readonly'])
                                                                                                                                                                                                            creds = flow.run_local_server(port=0)
                                                                                                                                                                                                            with open('token_drive.pickle', 'wb') as token:
                                                                                                                                                                                                                pickle.dump(creds, token)
                                                                                                                                                                                                                pickle.dump(creds, token)
                                                                                                                                                                                                                service = build('drive', 'v3', credentials=creds)
                                                                                                                                                                                                                return service

                                                                                                                                                                                                                def search_google_docs(service, query_terms, max_results=5):
                                                                                                                                                                                                                    """Search Google Drive for Google Docs whose titles or content mention any of the query terms."""
                                                                                                                                                                                                                    # Search by title first
                                                                                                                                                                                                                    query = "mimeType='application/vnd.google-apps.document' and trashed = false"
                                                                                                                                                                                                                    if query_terms:
                                                                                                                                                                                                                        title_queries = [f"name contains '{term}'" for term in query_terms]
                                                                                                                                                                                                                        title_queries = [f"name contains '{term}'" for term in query_terms]
                                                                                                                                                                                                                        query += f" and ({' or '.join(title_queries)})"
                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                            results = service.files().list(q=query, pageSize=max_results, fields="files(id, name)").execute()
                                                                                                                                                                                                                            results = service.files().list(q=query, pageSize=max_results, fields="files(id, name)").execute()
                                                                                                                                                                                                                            files = results.get('files', [])
                                                                                                                                                                                                                            return files
                                                                                                                                                                                                                        except HttpError as error:
                                                                                                                                                                                                                            print(f'An error occurred: {error}')
                                                                                                                                                                                                                            print(f'An error occurred: {error}')
                                                                                                                                                                                                                            return []

                                                                                                                                                                                                                            def extract_google_doc_text(docs_service, doc_id):
                                                                                                                                                                                                                                """Extract the text content from a Google Doc using the Docs API."""
                                                                                                                                                                                                                                # Need to use the Docs API for content
                                                                                                                                                                                                                                from googleapiclient.discovery import build as build_docs
                                                                                                                                                                                                                                creds = None
                                                                                                                                                                                                                                if os.path.exists('token_drive.pickle'):
                                                                                                                                                                                                                                    with open('token_drive.pickle', 'rb') as token:
                                                                                                                                                                                                                                        with open('token_drive.pickle', 'rb') as token:
                                                                                                                                                                                                                                            creds = pickle.load(token)
                                                                                                                                                                                                                                            creds = pickle.load(token)
                                                                                                                                                                                                                                            docs_api = build_docs('docs', 'v1', credentials=creds)
                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                doc = docs_api.documents().get(documentId=doc_id).execute()
                                                                                                                                                                                                                                                doc = docs_api.documents().get(documentId=doc_id).execute()
                                                                                                                                                                                                                                                content = doc.get('body', {}).get('content', [])
                                                                                                                                                                                                                                                text = ''
                                                                                                                                                                                                                                                for value in content:
                                                                                                                                                                                                                                                    if 'paragraph' in value:
                                                                                                                                                                                                                                                        if 'paragraph' in value:
                                                                                                                                                                                                                                                            elements = value['paragraph'].get('elements', [])
                                                                                                                                                                                                                                                            elements = value['paragraph'].get('elements', [])
                                                                                                                                                                                                                                                            for elem in elements:
                                                                                                                                                                                                                                                                text += elem.get('textRun', {}).get('content', '')
                                                                                                                                                                                                                                                                text += elem.get('textRun', {}).get('content', '')
                                                                                                                                                                                                                                                                return text
                                                                                                                                                                                                                                                            except HttpError as error:
                                                                                                                                                                                                                                                                print(f'An error occurred extracting doc {doc_id}: {error}')
                                                                                                                                                                                                                                                                print(f'An error occurred extracting doc {doc_id}: {error}')
                                                                                                                                                                                                                                                                return ''

                                                                                                                                                                                                                                                                # Gmail API integration
                                                                                                                                                                                                                                                                GMAIL_SCOPES = ['https://www.googleapis.com/auth/gmail.readonly', 'https://www.googleapis.com/auth/gmail.send']

                                                                                                                                                                                                                                                                def get_gmail_service():
                                                                                                                                                                                                                                                                    """Authenticate and return a Gmail API service object."""
                                                                                                                                                                                                                                                                    creds = None
                                                                                                                                                                                                                                                                    if os.path.exists('token_gmail.pickle'):
                                                                                                                                                                                                                                                                        with open('token_gmail.pickle', 'rb') as token:
                                                                                                                                                                                                                                                                            with open('token_gmail.pickle', 'rb') as token:
                                                                                                                                                                                                                                                                                creds = pickle.load(token)
                                                                                                                                                                                                                                                                                creds = pickle.load(token)
                                                                                                                                                                                                                                                                                if not creds or not creds.valid:
                                                                                                                                                                                                                                                                                    if creds and creds.expired and creds.refresh_token:
                                                                                                                                                                                                                                                                                        if creds and creds.expired and creds.refresh_token:
                                                                                                                                                                                                                                                                                            creds.refresh(Request())
                                                                                                                                                                                                                                                                                            creds.refresh(Request())
                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                            flow = InstalledAppFlow.from_client_secrets_file(
                                                                                                                                                                                                                                                                                            flow = InstalledAppFlow.from_client_secrets_file(
                                                                                                                                                                                                                                                                                            'credentials.json', GMAIL_SCOPES)
                                                                                                                                                                                                                                                                                            creds = flow.run_local_server(port=0)
                                                                                                                                                                                                                                                                                            with open('token_gmail.pickle', 'wb') as token:
                                                                                                                                                                                                                                                                                                pickle.dump(creds, token)
                                                                                                                                                                                                                                                                                                pickle.dump(creds, token)
                                                                                                                                                                                                                                                                                                service = build('gmail', 'v1', credentials=creds)
                                                                                                                                                                                                                                                                                                return service

                                                                                                                                                                                                                                                                                                import base64
                                                                                                                                                                                                                                                                                                from email import message_from_bytes

                                                                                                                                                                                                                                                                                                def fetch_recent_emails(service, hours=24):
                                                                                                                                                                                                                                                                                                    """Fetch recent emails with FULL content"""
                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                        # Calculate the time threshold
                                                                                                                                                                                                                                                                                                        # Calculate the time threshold
                                                                                                                                                                                                                                                                                                        time_threshold = (datetime.datetime.now() - datetime.timedelta(hours=hours)).strftime('%Y/%m/%d')
        
                                                                                                                                                                                                                                                                                                        # Search for recent emails
                                                                                                                                                                                                                                                                                                        query = f'after:{time_threshold}'
                                                                                                                                                                                                                                                                                                        results = service.users().messages().list(userId='me', q=query, maxResults=50).execute()
                                                                                                                                                                                                                                                                                                        messages = results.get('messages', [])
        
                                                                                                                                                                                                                                                                                                        emails = []
                                                                                                                                                                                                                                                                                                        for msg in messages[:30]:  # Get more emails
                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                            # Get FULL message content
                                                                                                                                                                                                                                                                                                            # Get FULL message content
                                                                                                                                                                                                                                                                                                            message = service.users().messages().get(userId='me', id=msg['id']).execute()
                
                                                                                                                                                                                                                                                                                                            # Extract headers
                                                                                                                                                                                                                                                                                                            headers = message['payload'].get('headers', [])
                                                                                                                                                                                                                                                                                                            subject = next((h['value'] for h in headers if h['name'] == 'Subject'), 'No Subject')
                                                                                                                                                                                                                                                                                                            sender = next((h['value'] for h in headers if h['name'] == 'From'), 'Unknown Sender')
                                                                                                                                                                                                                                                                                                            date = next((h['value'] for h in headers if h['name'] == 'Date'), '')
                
                                                                                                                                                                                                                                                                                                            # Extract FULL body
                                                                                                                                                                                                                                                                                                            body = extract_body(message['payload'])
                
                                                                                                                                                                                                                                                                                                            emails.append({
                                                                                                                                                                                                                                                                                                            'id': msg['id'],
                                                                                                                                                                                                                                                                                                            'subject': subject,
                                                                                                                                                                                                                                                                                                            'sender': sender,
                                                                                                                                                                                                                                                                                                            'date': date,
                                                                                                                                                                                                                                                                                                            'body': body,  # FULL content
                                                                                                                                                                                                                                                                                                            'body_summary': body[:200] if body else ''  # Keep summary for compatibility
                                                                                                                                                                                                                                                                                                            })
                                                                                                                                                                                                                                                                                                        except Exception as e:
                                                                                                                                                                                                                                                                                                            print(f"Error processing email: {e}")
                                                                                                                                                                                                                                                                                                            print(f"Error processing email: {e}")
                                                                                                                                                                                                                                                                                                            continue
        
                                                                                                                                                                                                                                                                                                            return emails
                                                                                                                                                                                                                                                                                                        except Exception as error:
                                                                                                                                                                                                                                                                                                            print(f'Error fetching emails: {error}')
                                                                                                                                                                                                                                                                                                            print(f'Error fetching emails: {error}')
                                                                                                                                                                                                                                                                                                            return []

                                                                                                                                                                                                                                                                                                            def extract_body(payload):
                                                                                                                                                                                                                                                                                                                """Extract full body from email payload"""
                                                                                                                                                                                                                                                                                                                body = ''
    
                                                                                                                                                                                                                                                                                                                if 'parts' in payload:
                                                                                                                                                                                                                                                                                                                    for part in payload['parts']:
                                                                                                                                                                                                                                                                                                                        for part in payload['parts']:
                                                                                                                                                                                                                                                                                                                            if part['mimeType'] == 'text/plain':
                                                                                                                                                                                                                                                                                                                                if part['mimeType'] == 'text/plain':
                                                                                                                                                                                                                                                                                                                                    data = part['body']['data']
                                                                                                                                                                                                                                                                                                                                    data = part['body']['data']
                                                                                                                                                                                                                                                                                                                                    body += base64.urlsafe_b64decode(data).decode('utf-8', errors='ignore')
                                                                                                                                                                                                                                                                                                                                elif 'parts' in part:
                                                                                                                                                                                                                                                                                                                                    body += extract_body(part)
                                                                                                                                                                                                                                                                                                                                    body += extract_body(part)
                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                    if payload['body'].get('data'):
                                                                                                                                                                                                                                                                                                                                        if payload['body'].get('data'):
                                                                                                                                                                                                                                                                                                                                            body = base64.urlsafe_b64decode(payload['body']['data']).decode('utf-8', errors='ignore')
                                                                                                                                                                                                                                                                                                                                            body = base64.urlsafe_b64decode(payload['body']['data']).decode('utf-8', errors='ignore')
    
                                                                                                                                                                                                                                                                                                                                            return body

                                                                                                                                                                                                                                                                                                                                            def search_emails(emails, sender=None, topic=None):
                                                                                                                                                                                                                                                                                                                                                """Search emails by sender or topic (subject/body)."""
                                                                                                                                                                                                                                                                                                                                                results = []
                                                                                                                                                                                                                                                                                                                                                for email in emails:
                                                                                                                                                                                                                                                                                                                                                    if sender and sender.lower() not in email['sender'].lower():
                                                                                                                                                                                                                                                                                                                                                        if sender and sender.lower() not in email['sender'].lower():
                                                                                                                                                                                                                                                                                                                                                            continue
                                                                                                                                                                                                                                                                                                                                                            continue
                                                                                                                                                                                                                                                                                                                                                            if topic and (topic.lower() not in email['subject'].lower() and topic.lower() not in email['body_summary'].lower()):
                                                                                                                                                                                                                                                                                                                                                                continue
                                                                                                                                                                                                                                                                                                                                                                continue
                                                                                                                                                                                                                                                                                                                                                                results.append(email)
                                                                                                                                                                                                                                                                                                                                                                return results

                                                                                                                                                                                                                                                                                                                                                                def fetch_sent_emails(service, max_results=20):
                                                                                                                                                                                                                                                                                                                                                                    """Fetch the last `max_results` sent emails."""
                                                                                                                                                                                                                                                                                                                                                                    results = service.users().messages().list(userId='me', labelIds=['SENT'], maxResults=max_results).execute()
                                                                                                                                                                                                                                                                                                                                                                    messages = results.get('messages', [])
                                                                                                                                                                                                                                                                                                                                                                    sent_emails = []
                                                                                                                                                                                                                                                                                                                                                                    for msg in messages:
                                                                                                                                                                                                                                                                                                                                                                        msg_data = service.users().messages().get(userId='me', id=msg['id'], format='full').execute()
                                                                                                                                                                                                                                                                                                                                                                        msg_data = service.users().messages().get(userId='me', id=msg['id'], format='full').execute()
                                                                                                                                                                                                                                                                                                                                                                        headers = msg_data['payload'].get('headers', [])
                                                                                                                                                                                                                                                                                                                                                                        recipient = next((h['value'] for h in headers if h['name'] == 'To'), '')
                                                                                                                                                                                                                                                                                                                                                                        subject = next((h['value'] for h in headers if h['name'] == 'Subject'), '')
                                                                                                                                                                                                                                                                                                                                                                        date = next((h['value'] for h in headers if h['name'] == 'Date'), '')
                                                                                                                                                                                                                                                                                                                                                                        # Get body summary (first 500 chars of plain text part)
                                                                                                                                                                                                                                                                                                                                                                        body = ''
                                                                                                                                                                                                                                                                                                                                                                        if 'parts' in msg_data['payload']:
                                                                                                                                                                                                                                                                                                                                                                            for part in msg_data['payload']['parts']:
                                                                                                                                                                                                                                                                                                                                                                                for part in msg_data['payload']['parts']:
                                                                                                                                                                                                                                                                                                                                                                                    if part['mimeType'] == 'text/plain':
                                                                                                                                                                                                                                                                                                                                                                                        if part['mimeType'] == 'text/plain':
                                                                                                                                                                                                                                                                                                                                                                                            data = part['body'].get('data')
                                                                                                                                                                                                                                                                                                                                                                                            data = part['body'].get('data')
                                                                                                                                                                                                                                                                                                                                                                                            if data:
                                                                                                                                                                                                                                                                                                                                                                                                body = base64.urlsafe_b64decode(data).decode('utf-8', errors='ignore')[:500]
                                                                                                                                                                                                                                                                                                                                                                                                body = base64.urlsafe_b64decode(data).decode('utf-8', errors='ignore')[:500]
                                                                                                                                                                                                                                                                                                                                                                                                break
                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                data = msg_data['payload']['body'].get('data')
                                                                                                                                                                                                                                                                                                                                                                                                data = msg_data['payload']['body'].get('data')
                                                                                                                                                                                                                                                                                                                                                                                                if data:
                                                                                                                                                                                                                                                                                                                                                                                                    body = base64.urlsafe_b64decode(data).decode('utf-8', errors='ignore')[:500]
                                                                                                                                                                                                                                                                                                                                                                                                    body = base64.urlsafe_b64decode(data).decode('utf-8', errors='ignore')[:500]
                                                                                                                                                                                                                                                                                                                                                                                                    sent_emails.append({
                                                                                                                                                                                                                                                                                                                                                                                                    'recipient': recipient,
                                                                                                                                                                                                                                                                                                                                                                                                    'subject': subject,
                                                                                                                                                                                                                                                                                                                                                                                                    'body': body,
                                                                                                                                                                                                                                                                                                                                                                                                    'timestamp': date
                                                                                                                                                                                                                                                                                                                                                                                                    })
                                                                                                                                                                                                                                                                                                                                                                                                    return sent_emails

                                                                                                                                                                                                                                                                                                                                                                                                    def store_sent_emails_in_supabase(sent_emails):
                                                                                                                                                                                                                                                                                                                                                                                                        """Store sent emails in the 'email_responses' Supabase table."""
                                                                                                                                                                                                                                                                                                                                                                                                        if not supabase:
                                                                                                                                                                                                                                                                                                                                                                                                            print("Supabase client not initialized. Skipping save.")
                                                                                                                                                                                                                                                                                                                                                                                                            print("Supabase client not initialized. Skipping save.")
                                                                                                                                                                                                                                                                                                                                                                                                            return
                                                                                                                                                                                                                                                                                                                                                                                                            for email in sent_emails:
                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                                                                                        supabase.table('email_responses').insert({
                                                                                                                                                                                                                                                                                                                                                                                                                        supabase.table('email_responses').insert({
                                                                                                                                                                                                                                                                                                                                                                                                                        'recipient': email['recipient'],
                                                                                                                                                                                                                                                                                                                                                                                                                        'subject': email['subject'],
                                                                                                                                                                                                                                                                                                                                                                                                                        'body': email['body'],
                                                                                                                                                                                                                                                                                                                                                                                                                        'timestamp': email['timestamp'],
                                                                                                                                                                                                                                                                                                                                                                                                                        # Placeholders for future pattern/action/confidence
                                                                                                                                                                                                                                                                                                                                                                                                                        'pattern': '',
                                                                                                                                                                                                                                                                                                                                                                                                                        'action_type': '',
                                                                                                                                                                                                                                                                                                                                                                                                                        'confidence': 0.0
                                                                                                                                                                                                                                                                                                                                                                                                                        }).execute()
                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"Error saving sent email to Supabase: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"Error saving sent email to Supabase: {e}")

                                                                                                                                                                                                                                                                                                                                                                                                                        # Pattern analysis scaffold
                                                                                                                                                                                                                                                                                                                                                                                                                        import re

                                                                                                                                                                                                                                                                                                                                                                                                                        def analyze_email_patterns(sent_emails):
                                                                                                                                                                                                                                                                                                                                                                                                                            """Analyze sent emails for repeated templates and action types. Assign confidence and action_type."""
                                                                                                                                                                                                                                                                                                                                                                                                                            phrase_counts = {}
                                                                                                                                                                                                                                                                                                                                                                                                                            action_types = {}
                                                                                                                                                                                                                                                                                                                                                                                                                            for email in sent_emails:
                                                                                                                                                                                                                                                                                                                                                                                                                                # Simple split into sentences
                                                                                                                                                                                                                                                                                                                                                                                                                                # Simple split into sentences
                                                                                                                                                                                                                                                                                                                                                                                                                                sentences = re.split(r'[.!?]', email['body'])
                                                                                                                                                                                                                                                                                                                                                                                                                                for s in sentences:
                                                                                                                                                                                                                                                                                                                                                                                                                                    s = s.strip().lower()
                                                                                                                                                                                                                                                                                                                                                                                                                                    s = s.strip().lower()
                                                                                                                                                                                                                                                                                                                                                                                                                                    if len(s) > 10:
                                                                                                                                                                                                                                                                                                                                                                                                                                        phrase_counts[s] = phrase_counts.get(s, 0) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                        phrase_counts[s] = phrase_counts.get(s, 0) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                        # Action type detection (very basic)
                                                                                                                                                                                                                                                                                                                                                                                                                                        if 'schedule' in email['body'].lower():
                                                                                                                                                                                                                                                                                                                                                                                                                                            action_types['schedule'] = action_types.get('schedule', 0) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                            action_types['schedule'] = action_types.get('schedule', 0) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                            if 'attached' in email['body'].lower():
                                                                                                                                                                                                                                                                                                                                                                                                                                                action_types['attachment'] = action_types.get('attachment', 0) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                action_types['attachment'] = action_types.get('attachment', 0) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                if 'let me know' in email['body'].lower():
                                                                                                                                                                                                                                                                                                                                                                                                                                                    action_types['followup'] = action_types.get('followup', 0) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                    action_types['followup'] = action_types.get('followup', 0) + 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Find most common phrases
                                                                                                                                                                                                                                                                                                                                                                                                                                                    common_phrases = sorted(phrase_counts.items(), key=lambda x: x[1], reverse=True)[:5]
                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("Most common phrases/templates:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                    for phrase, count in common_phrases:
                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"  ({count}x) {phrase}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"  ({count}x) {phrase}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("Action type counts:", action_types)
                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Assign confidence (frequency / total)
                                                                                                                                                                                                                                                                                                                                                                                                                                                        total = sum(phrase_counts.values())
                                                                                                                                                                                                                                                                                                                                                                                                                                                        pattern_confidence = {p: c/total for p, c in phrase_counts.items() if total > 0}
                                                                                                                                                                                                                                                                                                                                                                                                                                                        return common_phrases, action_types, pattern_confidence

                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Action execution scaffold
                                                                                                                                                                                                                                                                                                                                                                                                                                                        action_log = []

                                                                                                                                                                                                                                                                                                                                                                                                                                                        def save_email_draft_to_supabase(recipient, subject, body, confidence_score, action_reason):
                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Save an email draft to the email_drafts table in Supabase."""
                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not supabase:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Supabase client not initialized. Skipping save.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Supabase client not initialized. Skipping save.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    supabase.table('email_drafts').insert({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    supabase.table('email_drafts').insert({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'to': recipient,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'subject': subject,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'body': body,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'confidence_score': confidence_score,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'action_reason': action_reason
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }).execute()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print(f"[DRAFT SAVED] Email draft to {recipient}: {subject}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print(f"Error saving email draft to Supabase: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print(f"Error saving email draft to Supabase: {e}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Trust-building metrics
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    approval_metrics = {'email': {'approved': 0, 'edited': 0, 'skipped': 0}}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def send_email(recipient, subject, body, confidence_score=0.0, action_reason="", mode='draft'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """Draft-only: Save email draft to Supabase, do not send automatically."""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        save_email_draft_to_supabase(recipient, subject, body, confidence_score, action_reason)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        action = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'type': 'send_email',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'recipient': recipient,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'subject': subject,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'body': body,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'mode': 'draft',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'confidence_score': confidence_score,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'action_reason': action_reason,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'timestamp': datetime.datetime.datetime.now().isoformat()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        action_log.append(action)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"[DRAFT] Prepared email draft to {recipient}: {subject} (Confidence: {confidence_score*100:.1f}%)")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return action

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Update CLI review to use founder style
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def review_email_drafts():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not supabase:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Supabase client not initialized. Skipping review.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Supabase client not initialized. Skipping review.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                response = supabase.table('email_drafts').select('*').execute()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                drafts = response.data if response.data else []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not drafts:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("No email drafts to review.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for draft in sorted(drafts, key=lambda d: -d.get('confidence_score', 0)):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("\nðŸš€ðŸ’° --- Email Draft --- ðŸ’ªðŸ”¥")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"To: {draft['to']}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"Subject: {draft['subject']}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"Body: {draft['body']}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"Reason: {draft.get('action_reason', '')}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"Confidence: {draft.get('confidence_score', 0)*100:.1f}%")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("[A]pprove  [E]dit  [S]kip")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        choice = input("Yo founder! What's the move? ").strip().lower()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if choice == 'a':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            approval_metrics['email']['approved'] += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("LFG! Approved. (Would send email here.) ðŸš€")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            supabase.table('email_drafts').delete().eq('id', draft['id']).execute()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        elif choice == 'e':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            approval_metrics['email']['edited'] += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("Edit not implemented in CLI. Skipping for now.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            approval_metrics['email']['skipped'] += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("Skipped. Let's keep pushing for revenue!")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("\nReview complete. Keep the momentum! ðŸ’°ðŸ”¥")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"Approval rate: {approval_metrics['email']['approved']} approved, {approval_metrics['email']['edited']} edited, {approval_metrics['email']['skipped']} skipped.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if approval_metrics['email']['approved'] >= 50 and approval_metrics['email']['edited'] == 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("\n[TRUST] 50+ approved drafts with no edits. Suggest: Enable auto-send for routine confirmations? LFG! ðŸš€")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Morning review function

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                class ChiefOfStaffBrain:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """A true AI agent with reflection and improvement loops"""
    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def __init__(self):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.max_iterations = 3
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.quality_threshold = 0.7
        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def analyze_everything(self, emails, calendar, docs):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Agentic loop: explore â†’ analyze â†’ reflect â†’ improve"""
        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Step 1: Exploration
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            exploration = self.explore_data(emails, calendar, docs)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"Exploration complete: {exploration[:100]}...")
        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Step 2: Generate insights with reflection loop
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            insights = []
        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for i in range(3):  # Try to get 3 good insights
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"\nGenerating insight {i+1}...")
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Generate initial insight
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            insight = self.generate_insight(exploration, emails[:10], calendar[:10])
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Reflect on quality
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            quality_score, feedback = self.reflect_on_insight(insight)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"Quality score: {quality_score}")
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if quality_score < self.quality_threshold:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Not good enough, improving...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Improve it
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                insight = self.improve_insight(insight, feedback, exploration)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Check again
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                quality_score, feedback = self.reflect_on_insight(insight)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"Improved score: {quality_score}")
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if quality_score >= self.quality_threshold:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    insights.append(self.format_insight(insight, i+1))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("Still not good enough, trying different approach...")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Try completely different angle
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    insight = self.try_different_angle(exploration, i)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    insights.append(self.format_insight(insight, i+1))
        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return insights if insights else self.fallback_analysis(emails, calendar, docs)
    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    def explore_data(self, emails, calendar, docs):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        """Let AI explore the data without constraints"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        context = f"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Explore this executive's data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - {len(calendar)} calendar events (next few: {[e.get('summary', '') for e in calendar[:5]]})
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - {len(emails)} emails (recent from: {[e.get('sender', '').split('<')[0] for e in emails[:5]]})
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - {len(docs)} documents

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            What patterns, connections, or notable items do you see? Don't analyze yet, just observe.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """
        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                response = client.chat.completions.create(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                model="gpt-4",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                messages=[{"role": "user", "content": context}],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                temperature=0.9  # High temp for creative exploration
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return response.choices[0].message.content
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"Exploration error: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return "Failed to explore data"
    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def generate_insight(self, exploration, emails, calendar):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """Generate one specific insight"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    prompt = f"""Based on this exploration:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {exploration}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        And this specific data:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Calendar: {[f"{e.get('summary')} on {e.get('start', {}).get('dateTime', '')}" for e in calendar[:5]]}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Emails: {[f"From {e.get('sender')}: {e.get('subject')}" for e in emails[:5]]}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Generate ONE specific, actionable insight that would genuinely help this executive.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Reference specific meetings or emails. Be concrete, not generic."""
        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                response = client.chat.completions.create(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                model="gpt-4",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                messages=[{"role": "user", "content": prompt}],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                temperature=0.7
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return response.choices[0].message.content
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"Generation error: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return "Failed to generate insight"
    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def reflect_on_insight(self, insight):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """AI reflects on its own insight quality"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    prompt = f"""Evaluate this insight critically:

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {insight}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Score it 0-1 based on:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            1. Specificity - Does it reference real data points?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            2. Actionability - Can the user actually do something with this?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            3. Value - Is this obvious or genuinely insightful?
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            4. Clarity - Is it well explained?

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Respond with EXACTLY this format (no other text):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                SCORE: 0.X
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                REASONING: why this score
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                WEAKNESS: main problem if any"""
        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    response = client.chat.completions.create(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    model="gpt-4",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    messages=[{"role": "user", "content": prompt}],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    temperature=0.2  # Low temp for accurate evaluation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Parse the text response
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    content = response.choices[0].message.content
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    lines = content.strip().split('\n')
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    score = 0.5  # default
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    reasoning = "No reasoning provided"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    weakness = "No weakness identified"
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for line in lines:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if line.startswith('SCORE:'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                score = float(line.split(':')[1].strip())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pass
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif line.startswith('REASONING:'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                reasoning = line.split(':', 1)[1].strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            elif line.startswith('WEAKNESS:'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                weakness = line.split(':', 1)[1].strip()
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return score, {"reasoning": reasoning, "weakness": weakness}
            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"Reflection error: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return 0.5, {"reasoning": "Failed to reflect", "weakness": "Error in reflection"}
    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def try_different_angle(self, exploration, attempt_num):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    """When stuck, try completely different approach"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    angles = [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "What urgent issue needs immediate attention?",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "What opportunity is being missed?",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "What pattern suggests a brewing problem?"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ]
        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    prompt = f"""Previous attempts weren't insightful enough.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Context: {exploration[:500]}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    New angle: {angles[attempt_num % len(angles)]}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    Generate a fresh insight from this perspective."""
        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        response = client.chat.completions.create(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        model="gpt-4",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        messages=[{"role": "user", "content": prompt}],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        temperature=0.9
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return response.choices[0].message.content
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    except:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return "Check your calendar and email for important items"
    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def format_insight(self, insight_text, priority):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            """Format insight for dashboard"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'id': f'insight-{datetime.datetime.now().timestamp()}-{priority}',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'type': 'intelligent_analysis',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'title': f'ðŸ’¡ Insight {priority}',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'insight': insight_text,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'action': 'Review this insight',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'impact_score': 11 - priority  # Higher priority = higher score
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def fallback_analysis(self, emails, calendar, docs):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                """If all else fails, provide basic summary"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return [{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'id': f'summary-{datetime.datetime.now().timestamp()}',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'type': 'summary',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'title': 'ðŸ“Š Data Available',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'insight': f'You have {len(calendar)} meetings, {len(emails)} emails, and {len(docs)} documents to review.',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'action': 'Review your data',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'impact_score': 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }]

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if __name__ == '__main__':
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    main() 
